!function(window,angular,chrome,localStorage,undefined){"use strict";var SERVICE_ID="datacontextConfig";function datacontextConfigFactory($q,datacontextUtility){return new DatacontextConfig($q,datacontextUtility)}angular.module("powellDevTools").factory(SERVICE_ID,["$q","datacontextUtility",datacontextConfigFactory]);var _onBeforeJsRequestListener=function(request){var originalJsUrl=request.url,debugJsUrl=request.url,regIsOriginalUrl=/(cdn.powell-365.com|powell365-cdn.azureedge.net)\/scripts\/(?:powell(?:\/debug)?\?siteCollectionUrl=|Premium)/i,regIsCdnPremium=/powell365-cdn.azureedge.net/i,regIsReplacedUrl,isOriginalUrl;if(!/#powellDevTools=1/.exec(originalJsUrl)&&regIsOriginalUrl.exec(originalJsUrl)){var isCdnPremium=null!=regIsCdnPremium.exec(originalJsUrl);debugJsUrl=DatacontextConfig.utility.get_jsSourceUrl(isCdnPremium)+"#powellDevTools=1",console.log("Redirecting original request ["+originalJsUrl+"] to ["+debugJsUrl+"]")}return{redirectUrl:debugJsUrl}},_onBeforeCssRequestListener=function(request){var originalCssUrl=request.url,debugCssUrl=request.url,regIsOriginalUrl,regIsCdnPremium=/powell365-cdn.azureedge.net/i,regFileName=/[^\/\\&\?]+\.\w{3,4}(?=([\?&].*$|$))/;if(regIsOriginalUrl=DatacontextConfig.utility.get_defautCssOnCdnState()?/(?:cdn.powell-365.com|powell365-cdn.azureedge.net)\/styles\//i:DatacontextConfig.utility.get_defaultCssURL()){if(regIsOriginalUrl.exec&&null!==regIsOriginalUrl.exec(originalCssUrl)||originalCssUrl.indexOf(regIsOriginalUrl)>=0){var isCdnPremium=null!=regIsCdnPremium.exec(originalCssUrl),cssFileName=originalCssUrl.match(regFileName)[0];debugCssUrl=DatacontextConfig.utility.get_cssSourceUrl(cssFileName,isCdnPremium),console.log("Redirecting original request ["+originalCssUrl+"] to ["+debugCssUrl+"]")}return{redirectUrl:debugCssUrl}}},_isHeaderRequest=[],_onBeforeHeaderFooterRequestListener=function(request){_isHeaderRequest[request.tabId]=!_isHeaderRequest[request.tabId];var originalHtmlTemplateUrl=request.url,debugHtmlTemplateUrl=request.url,regIsCdnPremium,isCdnPremium=null!=/powell365-cdn.azureedge.net/i.exec(originalHtmlTemplateUrl);if(debugHtmlTemplateUrl=DatacontextConfig.utility.get_headerFooterHtmlTemplateUrl(originalHtmlTemplateUrl,_isHeaderRequest[request.tabId]),console.log("Redirecting original request ["+originalHtmlTemplateUrl+"] to ["+debugHtmlTemplateUrl+"]"),debugHtmlTemplateUrl!=originalHtmlTemplateUrl)return{redirectUrl:debugHtmlTemplateUrl}},_onBeforeXhrRequestListener=function(request){var originalXhrUrl=request.url,debugXhrUrl=request.url,regIsOriginalUrl,isOriginalUrl=/(?:cdn.powell-365.com|powell365-cdn.azureedge.net)\/+(?:(?:\w|\S)+\/+)+(\S+\.html)/i.exec(originalXhrUrl);if(isOriginalUrl){var originalTemplate=DatacontextConfig.utility.get_htmlTemplate(isOriginalUrl[1]);originalTemplate.isOverriden&&(debugXhrUrl=DatacontextConfig.utility.get_htmlSourceUrl(originalTemplate.fileName),console.log("Redirecting original request ["+originalXhrUrl+"] to ["+debugXhrUrl+"]"))}return{redirectUrl:debugXhrUrl}},_onBeforeLogoRequestListener=function(request){var originalLogoUrl=request.url,debugLogoUrl=request.url,regIsOriginalUrl,regIsCdnPremium=/powell365-cdn.azureedge.net/i,logoFileName="logo-my-portal.png";if(null!==/(?:cdn.powell-365.com|powell365-cdn.azureedge.net)\/styles.*\/logo-my-portal\.png/i.exec(originalLogoUrl)){var isCdnPremium=null!=regIsCdnPremium.exec(originalLogoUrl);debugLogoUrl=DatacontextConfig.utility.get_logoSourceUrl(logoFileName,isCdnPremium),console.log("Redirecting original request ["+originalLogoUrl+"] to ["+debugLogoUrl+"]")}return{redirectUrl:debugLogoUrl}},_onBeforeSendHeadersListener=function(request){for(var isRefererSet=!1,headers=request.requestHeaders,blockingResponse={},i=0,l=headers.length;i<l;++i)if("Referer"==headers[i].name){headers[i].value=DatacontextConfig.utility.get_xhrOrigin(),isRefererSet=!0;break}return isRefererSet||headers.push({name:"Referer",value:DatacontextConfig.utility.get_xhrOrigin()}),blockingResponse.requestHeaders=headers,blockingResponse},_onBeforeSendSearchQueryListener=function(request){var redirectUrl;return{redirectUrl:request.url+'#"%7B%22Querytext%22:%22%22,%22QueryTemplate%22:%22%7BsearchTerms%7D%20ContentClass=urn:content-class:SPSPeople%22%7D"'}},_buildFilters=function(powCdn,filterUrl){for(var filters=[],i=0;i<powCdn.length;i++)for(var j=0;j<filterUrl.length;j++)filters.push(powCdn[i]+filterUrl[j]);return filters},_setEnabled=function(enabled,sourceKind,extraData){if(enabled){var powCdn=["*://r7-cdn.powell-365.com/","*://cdn.powell-365.com/","*://r7-powell365-cdn.azureedge.net/","*://powell365-cdn.azureedge.net/"],logoUrl=["styles/Premium/*/*/*/images/logo-my-portal.png"],cssUrl=["styles/Premium/*/*/*/powell.css"],jsUrl=["scripts/Premium/*/*/*/powell"],headerFooterHtmlTemplateUrl=["Common/*/*/*//HtmlTemplates/*"],htmlTemplateUrl=["Common/*/*/*//layouts/*.html","Common/*/*/*//Templates/*/*.html","Common//Templates/*/*.html"],wildcard="*://*/*",filters={},opt_extraInfoSpec=["blocking"];switch(sourceKind){case"js":filters.types=["script"],filters.urls=_buildFilters(powCdn,jsUrl),chrome.webRequest.onBeforeRequest.addListener(_onBeforeJsRequestListener,filters,opt_extraInfoSpec);break;case"css":filters.types=["image"],filters.urls=_buildFilters(powCdn,logoUrl),chrome.webRequest.onBeforeRequest.addListener(_onBeforeLogoRequestListener,filters,opt_extraInfoSpec),filters.types=["stylesheet"],filters.urls=_buildFilters(powCdn,cssUrl),filters.urls.push(wildcard),chrome.webRequest.onBeforeRequest.addListener(_onBeforeCssRequestListener,filters,opt_extraInfoSpec),filters.urls=_buildFilters(powCdn,headerFooterHtmlTemplateUrl),filters.types=["xmlhttprequest"],chrome.webRequest.onBeforeRequest.addListener(_onBeforeHeaderFooterRequestListener,filters,opt_extraInfoSpec);break;case"html":filters.urls=_buildFilters(powCdn,htmlTemplateUrl),filters.types=["xmlhttprequest"],chrome.webRequest.onBeforeRequest.addListener(_onBeforeXhrRequestListener,filters,opt_extraInfoSpec);case"xhr":filters.urls=_buildFilters(powCdn,["*"]),filters.types=["xmlhttprequest"],opt_extraInfoSpec.push("requestHeaders"),chrome.webRequest.onBeforeSendHeaders.addListener(_onBeforeSendHeadersListener,filters,opt_extraInfoSpec)}}else switch(sourceKind){case"js":chrome.webRequest.onBeforeRequest.removeListener(_onBeforeJsRequestListener);break;case"css":chrome.webRequest.onBeforeRequest.removeListener(_onBeforeCssRequestListener),chrome.webRequest.onBeforeRequest.removeListener(_onBeforeLogoRequestListener);break;case"xhr":chrome.webRequest.onBeforeSendHeaders.removeListener(_onBeforeSendHeadersListener)}DatacontextConfig.utility.set_isEnabled(sourceKind,enabled),_updateIcon()},_updateOnBeforeHeaderFooterRequestListener=function(requestName,requestValue){chrome.webRequest.onBeforeRequest.hasListener(_onBeforeHeaderFooterRequestListener)},_checkScriptFreshness=function(globalMD5){globalMD5!=window.PDT_GLOBAL&&chrome.runtime.reload()},_updateIcon=function(){var currentState=DatacontextConfig.utility.enabledFourState(),color=(DatacontextConfig.icons[currentState]||DatacontextConfig.icons.all).color,text=DatacontextConfig.icons[currentState]&&DatacontextConfig.icons[currentState].text||currentState,icon=(DatacontextConfig.icons[currentState]||DatacontextConfig.icons.all).icon;chrome.browserAction.setBadgeBackgroundColor({color:color}),chrome.browserAction.setBadgeText({text:text}),chrome.browserAction.setIcon({path:icon})},_onRequest=function(request,sender,callback){return"powDevTools.setEnabled"==request.action&&_setEnabled(request.enabled,request.sourceKind),"powDevTools.checkScriptFreshness"==request.action&&_checkScriptFreshness(request.globalMD5),"powDevTools.valueUpdated"==request.action&&_updateOnBeforeHeaderFooterRequestListener(request.data.name,request.data.value),!0},DatacontextConfig=function($q,datacontextUtility){DatacontextConfig.$q=$q,DatacontextConfig.utility=datacontextUtility,DatacontextConfig.icons={js:{color:"#EFBE19",text:"js",icon:"resources/img/icon19.png"},css:{color:"#2FA9DA",text:"css",icon:"resources/img/icon19.png"},html:{color:"#cd62f3",text:"html",icon:"resources/img/icon19.png"},xhr:{color:"#2af32d",text:"xhr",icon:"resources/img/icon19.png"},all:{color:"#F3672A",text:"all",icon:"resources/img/icon19.png"},none:{color:"#000",text:"none",icon:"resources/img/icon19_disabled.png"}}},_init=function(){localStorage.PowellDevTools_js_enabled=!1,localStorage.PowellDevTools_css_enabled=!1,localStorage.PowellDevTools_xhr_enabled=!1,localStorage.PowellDevTools_html_enabled=!1,chrome.browserAction.setBadgeText({text:""}),chrome.runtime.onMessage.addListener(_onRequest),_updateIcon()};angular.module("powellDevTools").run(["datacontextConfig",_init]);var spContentScriptLoader={id:"PowellDevTools_SP_contentScript_loader",conditions:[new chrome.declarativeContent.PageStateMatcher({pageUrl:{urlMatches:".sharepoint.com",schemes:["https"]}})],actions:[new chrome.declarativeContent.RequestContentScript({js:["ipcafcbnkhgdaiefpfnmogkcnikmfifa"==chrome.runtime.id?"/resources/js/sp.contentscript.min.js":"/resources/js/sp.contentscript.js"]})]},pmContentScriptLoader={id:"PowellDevTools_PM_contentScript_loader",conditions:[new chrome.declarativeContent.PageStateMatcher({pageUrl:{urlMatches:"manager.powell-365.com|r7-powell365-manager.azurewebsites.net",schemes:["https"]}})],actions:[new chrome.declarativeContent.RequestContentScript({js:["ipcafcbnkhgdaiefpfnmogkcnikmfifa"==chrome.runtime.id?"/resources/js/pm.contentscript.min.js":"/resources/js/pm.contentscript.js"]})]};function doReplaceRules(details){chrome.declarativeContent.onPageChanged.getRules(undefined,function(rules){console.log("before remove",JSON.stringify(rules))}),chrome.declarativeContent.onPageChanged.removeRules(undefined,function(){chrome.declarativeContent.onPageChanged.getRules(undefined,function(rules){console.log("after remove",JSON.stringify(rules))}),chrome.declarativeContent.onPageChanged.addRules([spContentScriptLoader,pmContentScriptLoader],function(rules){chrome.declarativeContent.onPageChanged.getRules(undefined,function(rules){console.log("after add",JSON.stringify(rules))})})})}chrome.extension.inIncognitoContext?doReplaceRules():chrome.runtime.onInstalled.addListener(doReplaceRules)}(window,window.angular,window.chrome,window.localStorage);